<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ø±ÙƒØ² Ø§Ù„Ø³ÙŠØ·Ø±Ø© ÙˆØ§Ù„Ø·ÙˆØ§Ø±Ø¦ - Ù…Ø´ÙˆØ§Ø±ÙŠ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --danger: #ff0000; --dark: #0f0f0f; --accent: #00ff88; }
        body { font-family: 'Cairo'; margin: 0; display: flex; height: 100vh; overflow: hidden; background: var(--dark); }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #admin-login-screen { position: fixed; inset: 0; background: var(--dark); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .login-card { background: #1e1e1e; padding: 40px; border-radius: 20px; text-align: center; border: 2px solid #333; }
        .btn-google { background: white; color: #444; border: none; padding: 12px 25px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; margin-top: 20px; }

        /* Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        #sidebar { width: 400px; background: #181818; color: white; display: flex; flex-direction: column; box-shadow: 5px 0 20px rgba(0,0,0,1); }
        .header { padding: 25px; background: var(--danger); text-align: center; font-weight: bold; font-size: 22px; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .list-section { flex: 1; overflow-y: auto; padding: 15px; }
        
        #map { flex: 1; height: 100%; border-right: 1px solid #333; }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ø³ØªØºØ§Ø«Ø© Ù…Ø·ÙˆØ±Ø© */
        .sos-alert-card { 
            background: #2a0000; color: white; padding: 18px; border-radius: 15px; margin-bottom: 15px; 
            border: 2px solid var(--danger); cursor: pointer; position: relative;
            animation: glow-red 1.5s infinite;
        }
        @keyframes glow-red { 0% { box-shadow: 0 0 5px var(--danger); } 50% { box-shadow: 0 0 20px var(--danger); } 100% { box-shadow: 0 0 5px var(--danger); } }
        
        .address-box { font-size: 11px; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 5px; margin-top: 8px; color: #ff9f9f; line-height: 1.4; }

        .trip-card { background: #252525; padding: 12px; border-radius: 10px; margin-bottom: 10px; font-size: 13px; border-left: 5px solid var(--accent); }
        .btn-resolve { background: var(--accent); color: #000; border: none; padding: 8px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; width: 100%; }
        
        #danger-overlay { position: fixed; inset: 0; border: 15px solid var(--danger); z-index: 9000; pointer-events: none; display: none; animation: flash 0.5s infinite; }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="admin-login-screen">
        <div class="login-card">
            <h1 style="color:var(--danger)">ğŸš¨ Ù…Ø±ÙƒØ² Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø³ÙŠØ·Ø±Ø©</h1>
            <p>ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø¨Ø¯Ù‚Ø© Ù…ØªÙ†Ø§Ù‡ÙŠØ©</p>
            <button class="btn-google" id="btn-admin-login">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20">
                ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±
            </button>
        </div>
    </div>

    <div id="danger-overlay"></div>
    <audio id="alarm-sound" src="https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3" loop></audio>

    <div id="sidebar">
        <div class="header">ğŸ†˜ Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø§Ø³ØªØºØ§Ø«Ø© Ø§Ù„Ù†Ø´Ø·Ø©</div>
        <div class="list-section" id="sos-container">
            <p style="text-align:center; opacity:0.5; margin-top:30px;">Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„.. Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</p>
        </div>
        
        <div style="padding:12px; background:#111; font-size:14px; text-align:center; color: var(--accent); border-top: 1px solid #333;">ğŸš• Ø§Ù„Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø­ÙŠ Ù„Ù„Ø±Ø­Ù„Ø§Øª</div>
        <div class="list-section" id="trips-container"></div>
    </div>

    <div id="map"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD8R4p1WaBn6s4yQxWpZzUkfznphYUOqqs",
            authDomain: "web-app-fb3f8.firebaseapp.com",
            projectId: "web-app-fb3f8",
            storageBucket: "web-app-fb3f8.firebasestorage.app",
            messagingSenderId: "1067792665032",
            appId: "1:1067792665032:web:015d23d10e359490c2d8fd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const ADMIN_UID = "X2Ms0cpnOeRByHx4iCkVinJ8vsE3";

        document.getElementById('btn-admin-login').addEventListener('click', async () => {
            try { await signInWithPopup(auth, provider); }
            catch (e) { alert("ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„"); }
        });

        onAuthStateChanged(auth, (user) => {
            if (user && user.uid === ADMIN_UID) {
                document.getElementById('admin-login-screen').style.display = 'none';
                startOperationsRoom();
            } else if (user) {
                alert("ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©!");
                auth.signOut();
            }
        });

        async function getExactAddress(lat, lng) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ar`);
                const data = await res.json();
                return data.display_name || "Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†...";
            } catch (e) { return "ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø±Ø¹"; }
        }

        function startOperationsRoom() {
            const map = L.map('map', { zoomControl: true }).setView([30.04, 31.23], 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

            let markers = {};
            let circles = {};
            const alarm = document.getElementById('alarm-sound');

            onSnapshot(collection(db, "rides"), (snapshot) => {
                const sosBox = document.getElementById('sos-container');
                const tripBox = document.getElementById('trips-container');
                const overlay = document.getElementById('danger-overlay');
                
                let anySos = false;
                sosBox.innerHTML = "";
                tripBox.innerHTML = "";

                snapshot.forEach(async rideDoc => {
                    const data = rideDoc.data();
                    const id = rideDoc.id;
                    const loc = data.driverLocation || data.pickup;

                    if (data.sos_active === true) {
                        anySos = true;
                        const address = await getExactAddress(loc.lat, loc.lng);
                        
                        const card = document.createElement('div');
                        card.className = 'sos-alert-card';
                        card.innerHTML = `
                            <div style="font-weight:bold; font-size:16px;">ğŸ†˜ Ø¨Ù„Ø§Øº Ø¹Ø§Ø¬Ù„ Ù…Ù† ${data.sos_by === 'rider' ? 'Ø§Ù„Ø±Ø§ÙƒØ¨' : 'Ø§Ù„Ø³Ø§Ø¦Ù‚'}</div>
                            <div style="margin-top:5px;">Ø§Ù„Ø§Ø³Ù…: ${data.riderName}</div>
                            <div class="address-box">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¯Ù‚ÙŠÙ‚: ${address}</div>
                            <button class="btn-resolve" onclick="resolveEmergency('${id}')">ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø®Ø·Ø± ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ù„Ø§Øº âœ…</button>
                        `;
                        card.onclick = () => map.flyTo([loc.lat, loc.lng], 19, { animate: true, duration: 2 });
                        sosBox.appendChild(card);
                        updatePrecisionMarker(id, loc, 'red', map, markers, circles);
                    } 
                    else if (['accepted', 'arrived', 'started'].includes(data.status)) {
                        const card = document.createElement('div');
                        card.className = 'trip-card';
                        card.innerHTML = `ğŸš• ${data.riderName} Ù…Ø¹ ${data.driverName || 'Ø§Ù„ÙƒØ§Ø¨ØªÙ†'}`;
                        card.onclick = () => map.flyTo([loc.lat, loc.lng], 17);
                        tripBox.appendChild(card);
                        updatePrecisionMarker(id, loc, '#00ff88', map, markers, circles);
                    }
                });

                if (anySos) {
                    overlay.style.display = 'block';
                    alarm.play().catch(() => {});
                } else {
                    overlay.style.display = 'none';
                    alarm.pause();
                    if (sosBox.innerHTML === "") sosBox.innerHTML = '<p style="text-align:center; opacity:0.3;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·ÙˆØ§Ø±Ø¦</p>';
                }
            });
        }

        function updatePrecisionMarker(id, loc, color, map, markers, circles) {
            if (!loc) return;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©
            if (markers[id]) {
                markers[id].setLatLng([loc.lat, loc.lng]);
            } else {
                markers[id] = L.circleMarker([loc.lat, loc.lng], { 
                    color: color, 
                    radius: color === 'red' ? 12 : 7, 
                    fillOpacity: 1,
                    weight: 3
                }).addTo(map);
            }

            // Ø¥Ø¶Ø§ÙØ© Ù‡Ø§Ù„Ø© (Pulse Effect) Ø­ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡
            if (circles[id]) {
                circles[id].setLatLng([loc.lat, loc.lng]);
            } else {
                circles[id] = L.circle([loc.lat, loc.lng], {
                    radius: color === 'red' ? 50 : 20,
                    color: color,
                    fillOpacity: 0.1,
                    weight: 1
                }).addTo(map);
            }
        }

        window.resolveEmergency = async (id) => {
            if(confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŸ Ø³ÙŠØ®ØªÙÙŠ Ø§Ù„Ø¨Ù„Ø§Øº Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©.")) {
                await updateDoc(doc(db, "rides", id), { sos_active: false });
            }
        };
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ - Ù…Ø´ÙˆØ§Ø±ÙŠ</title>

    <link rel="manifest" href="manifest_driver.json">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --driver-theme: #27ae60;
            --dark: #2c3e50;
            --white: #ffffff;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Cairo', sans-serif;
            overflow: hidden;
            background: #f4f7f6;
        }

        #map {
            height: 70vh;
            width: 100vw;
            z-index: 1;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„/Ø§Ù„Ø±Ø§Ø¯Ø§Ø± */
        .status-header {
            position: fixed;
            top: 0;
            width: 100%;
            background: var(--dark);
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© */
        .order-card {
            position: fixed;
            bottom: 20px;
            left: 5%;
            width: 90%;
            background: var(--white);
            z-index: 1000;
            border-radius: 15px;
            padding: 20px;
            box-sizing: border-box;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            /* ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨ */
            border: 2px solid var(--driver-theme);
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .btn {
            width: 100%;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-accept {
            background: var(--driver-theme);
            color: white;
        }

        .btn-finish {
            background: #e74c3c;
            color: white;
            display: none;
        }

        #online-toggle {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 12px;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #auth-screen {
            position: fixed;
            inset: 0;
            background: var(--dark);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        input {
            width: 80%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: none;
        }
    </style>
</head>

<body>

    <div id="auth-screen">
        <h1>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</h1>
        <input type="email" id="email" placeholder="Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¦Ù‚">
        <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn btn-accept" style="width: 80%;" onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div class="status-header" id="header-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø±Ø§Ø¯Ø§Ø±...</div>

    <div id="online-toggle">
        <input type="checkbox" id="go-online" onchange="toggleOnline()"> ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯
    </div>

    <div id="map"></div>

    <div class="order-card" id="request-card">
        <h3 style="margin:0">Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯! ğŸš—</h3>
        <p id="client-info">Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„: Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...</p>
        <button class="btn btn-accept" id="action-btn" onclick="acceptRide()">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨</button>
        <button class="btn btn-finish" id="finish-btn" onclick="finishRide()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        let myVerifiedData = null;

        const firebaseConfig = {
            apiKey: "AIzaSyD8R4p1WaBn6s4yQxWpZzUkfznphYUOqqs",
            authDomain: "web-app-fb3f8.firebaseapp.com",
            projectId: "web-app-fb3f8",
            storageBucket: "web-app-fb3f8.firebasestorage.app",
            messagingSenderId: "1067792665032",
            appId: "1:1067792665032:web:015d23d10e359490c2d8fd",
            measurementId: "G-7KFBEHHB7W"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let map, driverMarker, currentRideId = null, watchId = null;

        // 1. Ø§Ù„Ø¯Ø®ÙˆÙ„
        window.login = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try { await signInWithEmailAndPassword(auth, email, pass); }
            catch (e) { alert("Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ Ø£Ø¯Ø®Ù„Ù‡Ø§ Ø§Ù„Ø£Ø¯Ù…Ù† (Ø£Ù†Øª) Ø­ØµØ±Ø§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø§Ø¦Ù‚
                const docRef = doc(db, "verified_drivers", user.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    myVerifiedData = docSnap.data();
                    document.getElementById('auth-screen').style.display = 'none';
                    initDriverMap();
                    console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø±Ø³Ù…ÙŠØ© ÙŠØ§ ÙƒØ§Ø¨ØªÙ†:", myVerifiedData.driverName);
                } else {
                    alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ø¹Ø¯.");
                    auth.signOut(); // Ø·Ø±Ø¯Ù‡ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ø£Ù†Ù‡ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¹Ù†Ø¯Ùƒ
                }
            }
        });



        function initDriverMap() {
            map = L.map('map', { zoomControl: false }).setView([30.0444, 31.2357], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            navigator.geolocation.getCurrentPosition(pos => {
                const p = [pos.coords.latitude, pos.coords.longitude];
                map.setView(p, 15);
                driverMarker = L.marker(p, { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/235/235889.png', iconSize: [40, 40] }) }).addTo(map);
            });
        }

        // 2. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ø­Ù„Ø§Øª (Ø§Ù„Ø±Ø§Ø¯Ø§Ø±)
        window.toggleOnline = () => {
            const isOnline = document.getElementById('go-online').checked;
            const header = document.getElementById('header-text');

            if (isOnline) {
                header.innerText = "Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ù…ØªØ§Ø­ Ù„ØªÙ„Ù‚ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª";
                header.style.background = "#27ae60";
                startRadar();
            } else {
                header.innerText = "Ø£Ù†Øª ØºÙŠØ± Ù…ØªØµÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹";
                header.style.background = "#2c3e50";
            }
        };

        function startRadar() {
            const q = query(collection(db, "rides"), where("status", "==", "searching"));
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        showRequest(change.doc.id, change.doc.data());
                    }
                });
            });
        }

        function showRequest(id, data) {
            currentRideId = id;
            document.getElementById('request-card').style.display = 'block';
            document.getElementById('client-info').innerText = "Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ ÙŠØ·Ù„Ø¨ Ø±Ø­Ù„Ø©!";
        }

        // Ø¹Ù†Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ Ø¬Ù„Ø¨Ù†Ø§Ù‡Ø§ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†
        window.acceptRide = async () => {
            if (!currentRideId || !myVerifiedData) return;

            await updateDoc(doc(db, "rides", currentRideId), {
                status: "accepted",
                driverId: auth.currentUser.uid,
                driverName: myVerifiedData.driverName,
                driverPhone: myVerifiedData.driverPhone,
                carModel: myVerifiedData.carModel,
                carColor: myVerifiedData.carColor,
                carPlate: myVerifiedData.carPlate,
                driverLocation: currentDriverLatLng
            });
        };

        document.getElementById('action-btn').style.display = 'none';
        document.getElementById('finish-btn').style.display = 'block';
        document.getElementById('header-text').innerText = "Ù…ØªØ¬Ù‡ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¢Ù†...";

        // Ø¨Ø¯Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ø±Ø§ÙƒØ¨ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
        watchId = navigator.geolocation.watchPosition(async (pos) => {
            const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            // ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡
            driverMarker.setLatLng([loc.lat, loc.lng]);
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù€ Firebase Ù„ÙƒÙŠ ÙŠØ±Ø§Ù‡ Ø§Ù„Ø±Ø§ÙƒØ¨
            await updateDoc(doc(db, "rides", currentRideId), {
                driverLocation: loc
            });
        });

        window.finishRide = async () => {
            await updateDoc(doc(db, "rides", currentRideId), { status: "completed" });
            navigator.geolocation.clearWatch(watchId);
            location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØµÙÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
        }
    </script>
</body>

</html>
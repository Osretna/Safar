<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø´ÙˆØ§Ø±ÙŠ - ÙƒØ§Ø¨ØªÙ†</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --driver-green: #27ae60;
            --dark-bg: #1a1a1a;
            --red: #e74c3c;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Cairo', sans-serif;
            background: #f0f2f5;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            z-index: 1;
        }

        #auth-screen {
            position: fixed;
            inset: 0;
            background: var(--dark-bg);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .google-btn {
            background: #fff;
            color: #444;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Cairo';
        }

        .status-bar {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 1000;
            font-weight: bold;
            backdrop-filter: blur(5px);
            transition: 0.3s;
        }

        .ride-alert {
            position: fixed;
            bottom: 30px;
            left: 5%;
            width: 90%;
            background: white;
            z-index: 1100;
            border-radius: 20px;
            padding: 25px;
            box-sizing: border-box;
            display: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            border-bottom: 8px solid var(--driver-green);
            text-align: center;
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }

            100% {
                transform: scale(1);
            }
        }

        .on-trip-panel {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: white;
            z-index: 1200;
            padding: 20px;
            border-radius: 30px 30px 0 0;
            display: none;
            text-align: center;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.2);
        }

        .btn {
            width: 100%;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            transition: 0.2s;
        }

        .recenter-btn {
            position: fixed;
            right: 20px;
            bottom: 260px;
            width: 55px;
            height: 55px;
            background: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1500;
            cursor: pointer;
            border: 2px solid var(--driver-green);
            color: var(--driver-green);
            font-size: 26px;
        }

        .sos-btn {
            position: fixed;
            top: 80px;
            left: 20px;
            background: var(--red);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            z-index: 3000;
            border: none;
            font-weight: bold;
            display: none;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
            cursor: pointer;
        }
    </style>
</head>

<body>

    <button id="sos-btn-driver" class="sos-btn" onclick="triggerDriverSOS()">SOS</button>
    <div id="recenter-btn" class="recenter-btn" onclick="enableFollowMode()">ğŸ¯</div>

    <div id="auth-screen">
        <h1 style="color: var(--driver-green);">Ù…Ø´ÙˆØ§Ø±ÙŠ - ÙƒØ§Ø¨ØªÙ†</h1>
        <button class="google-btn" id="driver-login-btn">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„</button>
    </div>

    <div class="status-bar" id="status-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…...</div>
    <div id="map"></div>

    <div id="ride-alert" class="ride-alert">
        <h2 style="margin:0 0 10px 0;">Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯! ğŸš—</h2>
        <div id="ride-details" style="margin-bottom: 15px; font-size: 14px; color: #555;"></div>
        <p id="fare-display"
            style="font-weight:bold; font-size: 24px; color: var(--driver-green); margin-bottom: 15px;"></p>

        <div style="margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 10px;">
            <input type="number" id="counter-price" placeholder="Ø§Ø·Ù„Ø¨ Ø³Ø¹Ø±Ùƒ Ø§Ù„Ø®Ø§ØµØŸ"
                style="width:120px; padding:8px; border-radius:5px; border:1px solid #ddd; text-align:center;">
            <button onclick="counterOffer()"
                style="background:#f39c12; border:none; padding:8px 15px; color:white; border-radius:5px; margin-top:5px; cursor:pointer; font-family:'Cairo';">Ø¥Ø±Ø³Ø§Ù„
                Ø¹Ø±Ø¶ Ø³Ø¹Ø±</button>
        </div>

        <button class="btn" style="background:var(--driver-green)" id="accept-btn">Ù‚Ø¨ÙˆÙ„ Ø¨Ø³Ø¹Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
    </div>

    <div id="on-trip-panel" class="on-trip-panel">
        <div id="trip-info" style="margin-bottom: 15px; font-weight: bold; color: #333; font-size: 16px;">Ø£Ù†Øª Ø§Ù„Ø¢Ù† ÙÙŠ
            Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø©</div>
        <button id="arrived-btn" class="btn" style="background:var(--driver-green)">ÙˆØµÙ„Øª Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø¡</button>
        <button id="cancel-noshow-btn" class="btn" style="background:#f39c12; display:none;"
            onclick="cancelRideDriver('noshow')">Ø¥Ù„ØºØ§Ø¡ (Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù… ÙŠØ¸Ù‡Ø±)</button>
        <button id="finish-btn" class="btn" style="background:#000;" onclick="finishRide()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ÙˆØªØ­ØµÙŠÙ„
            Ø§Ù„Ù…Ø¨Ù„Øº</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, query, where, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD8R4p1WaBn6s4yQxWpZzUkfznphYUOqqs",
            authDomain: "web-app-fb3f8.firebaseapp.com",
            projectId: "web-app-fb3f8",
            storageBucket: "web-app-fb3f8.firebasestorage.app",
            messagingSenderId: "1067792665032",
            appId: "1:1067792665032:web:015d23d10e359490c2d8fd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let map, driverMarker, pickupMarker, routeLine, currentRideId = null, myData = null, countdownTimer;
        let driverCurrentPos = null, isFollowMode = true;

        // 1. Ø§Ù„Ø¯Ø®ÙˆÙ„
        document.getElementById('driver-login-btn').addEventListener('click', () => signInWithPopup(auth, provider));

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const docSnap = await getDoc(doc(db, "verified_drivers", user.uid));
                if (docSnap.exists()) {
                    myData = docSnap.data();
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('status-text').innerText = "Ø§Ù„ÙƒØ§Ø¨ØªÙ† " + myData.driverName + " Ù…ØªØµÙ„";
                    initMap();
                    checkDriverState();
                    listenForNewRides();
                } else {
                    alert("Ø­Ø³Ø§Ø¨Ùƒ ØºÙŠØ± Ù…ÙØ¹Ù„!"); auth.signOut(); location.reload();
                }
            }
        });

        // 2. Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø© (Follow Mode)
        function initMap() {
            if (map) return;
            map = L.map('map', { zoomControl: false }).setView([30.04, 31.23], 17);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            map.on('movestart', () => { isFollowMode = false; document.getElementById('recenter-btn').style.display = 'flex'; });

            navigator.geolocation.watchPosition((pos) => {
                const { latitude, longitude } = pos.coords;
                driverCurrentPos = { lat: latitude, lng: longitude };

                if (!driverMarker) driverMarker = L.marker([latitude, longitude], { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/235/235889.png', iconSize: [45, 45] }) }).addTo(map);
                else driverMarker.setLatLng([latitude, longitude]);

                if (isFollowMode) map.panTo([latitude, longitude], { animate: true });
                if (currentRideId) updateDoc(doc(db, "rides", currentRideId), { driverLocation: driverCurrentPos });
            }, null, { enableHighAccuracy: true });
        }

        window.enableFollowMode = () => {
            isFollowMode = true;
            document.getElementById('recenter-btn').style.display = 'none';
            if (routeLine) map.fitBounds(routeLine.getBounds(), { padding: [40, 40], animate: true });
            else if (driverCurrentPos) map.setView([driverCurrentPos.lat, driverCurrentPos.lng], 17, { animate: true });
        };

        // 3. Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ø³Ø§ÙˆÙ…Ø©
        function listenForNewRides() {
            const q = query(collection(db, "rides"), where("status", "==", "searching"));
            onSnapshot(q, (snap) => {
                snap.docChanges().forEach(change => {
                    if (change.type === "added" && !currentRideId) {
                        const ride = change.doc.data();
                        currentRideId = change.doc.id;
                        showRideAlert(ride);
                    }
                });
            });
        }

        function showRideAlert(ride) {
            document.getElementById('ride-alert').style.display = 'block';
            document.getElementById('fare-display').innerText = ride.fare + " Ø¬.Ù…";
            document.getElementById('ride-details').innerText = `Ø¹Ù…ÙŠÙ„: ${ride.riderName} | Ø®ÙŠØ§Ø±Ø§Øª: ${ride.options?.ac ? 'â„ï¸' : ''} ${ride.options?.lady ? 'ğŸ‘©' : ''}`;
            if (pickupMarker) map.removeLayer(pickupMarker);
            pickupMarker = L.marker([ride.pickup.lat, ride.pickup.lng]).addTo(map).bindPopup("Ù…ÙƒØ§Ù† Ø§Ù„Ù„Ù‚Ø§Ø¡").openPopup();
            map.flyTo([ride.pickup.lat, ride.pickup.lng], 16);
        }

        window.counterOffer = async () => {
            const newPrice = document.getElementById('counter-price').value;
            if (!newPrice) return alert("Ø§Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø£ÙˆÙ„Ø§Ù‹");

            await updateDoc(doc(db, "rides", currentRideId), {
                status: "driver_offered",
                driver_price: newPrice,
                driverId: auth.currentUser.uid,
                driverName: myData.driverName,
                driverPhone: myData.driverPhone,
                carModel: myData.carModel,
                carPlate: myData.carPlate,
                carColor: myData.carColor
            });
            document.getElementById('ride-alert').style.display = 'none';
            document.getElementById('status-text').innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø³Ø¹Ø±Ùƒ...";
            setupRideListener(); // Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø¯
        };

        // 4. Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø© ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±
        document.getElementById('accept-btn').addEventListener('click', async () => {
            const q = await getDocs(query(collection(db, "rides"), where("driverId", "==", auth.currentUser.uid), where("status", "in", ["accepted", "arrived"])));
            if (!q.empty) return alert("Ù„Ø¯ÙŠÙƒ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø© Ø¨Ø§Ù„ÙØ¹Ù„!");

            await updateDoc(doc(db, "rides", currentRideId), {
                status: "accepted",
                driverId: auth.currentUser.uid,
                driverName: myData.driverName,
                driverPhone: myData.driverPhone,
                carModel: myData.carModel,
                carPlate: myData.carPlate,
                carColor: myData.carColor,
                driverLocation: driverCurrentPos
            });

            localStorage.setItem('driverActiveRideId', currentRideId);
            setupRideListener();
        });

        function setupRideListener() {
            onSnapshot(doc(db, "rides", currentRideId), (snap) => {
                const data = snap.data();
                if (!data) return;

                if (data.status === "accepted") {
                    document.getElementById('ride-alert').style.display = 'none';
                    document.getElementById('on-trip-panel').style.display = 'block';
                    document.getElementById('sos-btn-driver').style.display = 'block';
                    document.getElementById('status-text').innerText = "ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©! ØªÙˆØ¬Ù‡ Ù„Ù„Ø¹Ù…ÙŠÙ„";
                    document.getElementById('status-text').style.background = "var(--driver-green)";
                    drawRoute(data.pickup, data.destination);
                }

                if (data.status === "rejected") {
                    document.getElementById('status-text').innerText = "âš ï¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø±ÙØ¶ Ø³Ø¹Ø±Ùƒ! Ø¬Ø±Ø¨ Ø³Ø¹Ø± ØªØ§Ù†ÙŠ";
                    document.getElementById('status-text').style.background = "var(--red)";
                    document.getElementById('ride-alert').style.display = 'block';
                }

                if (data.status === "cancelled_rider") {
                    alert("Ù†Ø¹ØªØ°Ø±.. Ù‚Ø§Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©.");
                    localStorage.removeItem('driverActiveRideId');
                    location.reload();
                }
            });
        }

        async function checkDriverState() {
            const savedRideId = localStorage.getItem('driverActiveRideId');
            if (savedRideId) {
                const snap = await getDoc(doc(db, "rides", savedRideId));
                if (snap.exists() && !['completed', 'cancelled_driver'].includes(snap.data().status)) {
                    currentRideId = savedRideId;
                    setupRideListener();
                }
            }
        }

        async function drawRoute(start, end) {
            const url = `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`;
            const res = await fetch(url);
            const data = await res.json();
            if (data.routes[0]) {
                const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                if (routeLine) map.removeLayer(routeLine);
                routeLine = L.polyline(coords, { color: '#27ae60', weight: 6 }).addTo(map);
                map.fitBounds(routeLine.getBounds(), { padding: [40, 40], animate: true });
            }
        }

        // 5. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø­Ù„Ø©
        document.getElementById('arrived-btn').addEventListener('click', async () => {
            await updateDoc(doc(db, "rides", currentRideId), { status: "arrived", arrivalTime: Date.now() });
            document.getElementById('arrived-btn').style.display = 'none';
            let left = 60;
            countdownTimer = setInterval(() => {
                left--;
                document.getElementById('status-text').innerText = `Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„: ${left} Ø«Ø§Ù†ÙŠØ©`;
                if (left <= 0) {
                    clearInterval(countdownTimer);
                    document.getElementById('cancel-noshow-btn').style.display = 'block';
                    document.getElementById('status-text').innerText = "ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¢Ù†";
                }
            }, 1000);
        });

        window.cancelRideDriver = async (type) => {
            const reason = type === 'noshow' ? "Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù… ÙŠØ¸Ù‡Ø±" : prompt("Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ØŸ");
            if (reason) {
                await updateDoc(doc(db, "rides", currentRideId), { status: "cancelled_driver", cancelReason: reason });
                localStorage.removeItem('driverActiveRideId'); location.reload();
            }
        };

        window.finishRide = async () => {
            if (confirm("Ù‡Ù„ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø±Ø­Ù„Ø©ØŸ")) {
                await updateDoc(doc(db, "rides", currentRideId), { status: "completed" });
                localStorage.removeItem('driverActiveRideId'); location.reload();
            }
        };

        window.triggerDriverSOS = async () => {
            if (confirm("ğŸš¨ Ù‡Ù„ ØªØ¹Ø±Ø¶Øª Ù„ÙƒÙ…ÙŠÙ† Ø£Ùˆ Ø®Ø·Ø±ØŸ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹Ùƒ ÙÙˆØ±Ø§Ù‹ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©!")) {
                await updateDoc(doc(db, "rides", currentRideId), {
                    sos_active: true, // Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯
                    sos_by: "driver",
                    sos_time: Date.now(),
                    driver_sos_location: driverCurrentPos
                });
                alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØºØ§Ø«Ø© Ø¨Ù†Ø¬Ø§Ø­.");
            }
        };

    </script>
</body>

</html>
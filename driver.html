<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø´ÙˆØ§Ø±ÙŠ - ÙƒØ§Ø¨ØªÙ†</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --driver-green: #27ae60;
            --dark-bg: #1a1a1a;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Cairo', sans-serif;
            background: #f0f2f5;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            z-index: 1;
        }

        #auth-screen {
            position: fixed;
            inset: 0;
            background: var(--dark-bg);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .google-btn {
            background: #fff;
            color: #444;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 18px;
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Cairo';
        }

        .status-bar {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 1000;
            font-weight: bold;
            transition: 0.3s;
        }

        .ride-alert {
            position: fixed;
            bottom: 30px;
            left: 5%;
            width: 90%;
            background: white;
            z-index: 1100;
            border-radius: 20px;
            padding: 20px;
            box-sizing: border-box;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-bottom: 8px solid var(--driver-green);
        }

        .on-trip-panel {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: white;
            z-index: 1200;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: none;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.2);
            box-sizing: border-box;
            text-align: center;
        }

        .btn-accept {
            width: 100%;
            background: var(--driver-green);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>

    <div id="auth-screen">
        <h1 style="color: var(--driver-green);">Ù…Ø´ÙˆØ§Ø±ÙŠ - ÙƒØ§Ø¨ØªÙ†</h1>
        <button class="google-btn" onclick="loginDriver()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ø¬ÙˆØ¬Ù„</button>
    </div>

    <div class="status-bar" id="status-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
    <div id="map"></div>

    <div id="ride-alert" class="ride-alert">
        <h2 style="margin:0 0 10px 0;">Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯! ðŸš—</h2>
        <p id="fare-display" style="font-weight:bold; font-size: 20px; color: green;"></p>
        <button class="btn-accept" onclick="acceptRide()">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø¢Ù†</button>
    </div>

    <div id="on-trip-panel" class="on-trip-panel">
        <button id="arrived-btn" class="btn-accept" onclick="driverArrived()">ÙˆØµÙ„Øª Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø¡</button>
        <button id="cancel-noshow-btn" class="btn-accept" style="background:#f39c12; display:none;"
            onclick="cancelRideDriver('noshow')">Ø¥Ù„ØºØ§Ø¡ (Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù… ÙŠØ¸Ù‡Ø±)</button>
        <button id="cancel-general-btn" class="btn-accept" style="background:#e74c3c;"
            onclick="cancelRideDriver('general')">Ø¥Ù„ØºØ§Ø¡ Ù„Ø³Ø¨Ø¨ Ø¢Ø®Ø±</button>
        <button id="finish-btn" class="btn-accept" style="background:#000;" onclick="finishRide()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ÙˆØªØ­ØµÙŠÙ„
            Ø§Ù„Ù…Ø¨Ù„Øº</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, query, where, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD8R4p1WaBn6s4yQxWpZzUkfznphYUOqqs",
            authDomain: "web-app-fb3f8.firebaseapp.com",
            projectId: "web-app-fb3f8",
            storageBucket: "web-app-fb3f8.firebasestorage.app",
            messagingSenderId: "1067792665032",
            appId: "1:1067792665032:web:015d23d10e359490c2d8fd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let map, driverMarker, currentRideId = null, myData = null, countdownTimer;

        window.loginDriver = async () => {
            try { await signInWithPopup(auth, provider); }
            catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"); }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const docSnap = await getDoc(doc(db, "verified_drivers", user.uid));
                if (docSnap.exists()) {
                    myData = docSnap.data();
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('status-text').innerText = "Ø§Ù„ÙƒØ§Ø¨ØªÙ† " + myData.driverName + " Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†";
                    initMap();
                    listenForRides();
                } else {
                    alert("Ø­Ø³Ø§Ø¨Ùƒ ØºÙŠØ± Ù…ÙØ¹Ù„!"); auth.signOut(); location.reload();
                }
            }
        });

        function initMap() {
            if (map) return;
            map = L.map('map', { zoomControl: false }).setView([30.0444, 31.2357], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            navigator.geolocation.watchPosition((pos) => {
                const lat = pos.coords.latitude, lng = pos.coords.longitude;
                if (!driverMarker) {
                    driverMarker = L.marker([lat, lng], { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/235/235889.png', iconSize: [35, 35] }) }).addTo(map);
                } else {
                    driverMarker.setLatLng([lat, lng]);
                }
                if (currentRideId) {
                    updateDoc(doc(db, "rides", currentRideId), { driverLocation: { lat, lng } });
                }
            }, (err) => console.log(err), { enableHighAccuracy: true });
        }

        function listenForRides() {
            const q = query(collection(db, "rides"), where("status", "==", "searching"));
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added" && !currentRideId) {
                        const ride = change.doc.data();
                        currentRideId = change.doc.id;
                        document.getElementById('ride-alert').style.display = 'block';
                        document.getElementById('fare-display').innerText = "Ø§Ù„Ø£Ø¬Ø±Ø©: " + ride.fare + " Ø¬.Ù…";
                        L.marker([ride.pickup.lat, ride.pickup.lng]).addTo(map).bindPopup("Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„").openPopup();
                    }
                });
            });
        }

        window.acceptRide = async () => {
            if (!currentRideId || !myData) return;

            const qActive = query(collection(db, "rides"),
                where("driverId", "==", auth.currentUser.uid),
                where("status", "in", ["accepted", "arrived", "started"]));

            const activeTrips = await getDocs(qActive);
            if (!activeTrips.empty) {
                alert("Ù„Ø¯ÙŠÙƒ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹!"); return;
            }

            await updateDoc(doc(db, "rides", currentRideId), {
                status: "accepted",
                driverId: auth.currentUser.uid,
                driverName: myData.driverName,
                driverPhone: myData.driverPhone,
                carModel: myData.carModel,
                carPlate: myData.carPlate
            });

            document.getElementById('ride-alert').style.display = 'none';
            document.getElementById('on-trip-panel').style.display = 'block';
            document.getElementById('status-text').innerText = "Ù…ØªØ¬Ù‡ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¢Ù†...";
        };

        // --- ÙˆØ¸ÙŠÙØ© "ÙˆØµÙ„Øª" Ù…Ø¹ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ ---
        window.driverArrived = async () => {
            const arrivalTime = Date.now();
            await updateDoc(doc(db, "rides", currentRideId), {
                status: "arrived",
                arrivalTime: arrivalTime
            });

            document.getElementById('arrived-btn').style.display = 'none';
            startTimer(60); // 60 Ø«Ø§Ù†ÙŠØ©
        };

        function startTimer(seconds) {
            let timeLeft = seconds;
            const statusBar = document.getElementById('status-text');

            countdownTimer = setInterval(() => {
                timeLeft--;
                statusBar.innerText = "Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„: " + timeLeft + " Ø«Ø§Ù†ÙŠØ©";
                statusBar.style.background = "#f39c12";

                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    statusBar.innerText = "Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¥Ù„ØºØ§Ø¡.";
                    statusBar.style.background = "#e74c3c";
                    document.getElementById('cancel-noshow-btn').style.display = 'block';
                }
            }, 1000);
        }

        window.cancelRideDriver = async (type) => {
            let reason = "";
            if (type === 'noshow') {
                reason = "Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù… ÙŠØ­Ø¶Ø± ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯ (60 Ø«Ø§Ù†ÙŠØ©)";
            } else {
                reason = prompt("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ù„Ù„Ø¹Ù…ÙŠÙ„:");
                if (!reason) return;
            }

            if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©ØŸ")) {
                clearInterval(countdownTimer);
                await updateDoc(doc(db, "rides", currentRideId), {
                    status: "cancelled_driver",
                    cancelReason: reason
                });
                location.reload();
            }
        };

        window.finishRide = async () => {
            if (confirm("Ù‡Ù„ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø±Ø­Ù„Ø©ØŸ")) {
                clearInterval(countdownTimer);
                await updateDoc(doc(db, "rides", currentRideId), { status: "completed" });
                location.reload();
            }
        };

    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø´ÙˆØ§Ø±ÙŠ - Ø§Ø·Ù„Ø¨ Ø±Ø­Ù„ØªÙƒ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #000;
            --accent: #3498db;
            --green: #27ae60;
            --red: #e74c3c;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Cairo', sans-serif;
            background: #eee;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            z-index: 1;
        }

        #auth-screen {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .google-btn {
            background: #fff;
            color: #757575;
            border: 1px solid #ddd;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            font-weight: bold;
        }

        .google-btn img {
            width: 22px;
            margin-left: 10px;
        }

        .bottom-card {
            position: fixed;
            bottom: 20px;
            left: 5%;
            width: 90%;
            background: white;
            z-index: 1000;
            border-radius: 20px;
            padding: 15px;
            box-sizing: border-box;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            text-align: center;
            transition: 0.3s;
        }

        .search-container {
            position: relative;
            margin-bottom: 8px;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #ddd;
            font-family: 'Cairo';
            font-size: 14px;
            box-sizing: border-box;
            outline: none;
        }

        .suggestions {
            position: absolute;
            bottom: 100%;
            left: 0;
            width: 100%;
            background: white;
            border-radius: 10px;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 1001;
            max-height: 180px;
            overflow-y: auto;
            padding: 0;
            list-style: none;
            text-align: right;
            border: 1px solid #eee;
        }

        .suggestions li {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 13px;
        }

        .suggestions li:hover {
            background: #f9f9f9;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }

        .opt-btn {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 10px;
            font-size: 11px;
            cursor: pointer;
            font-weight: bold;
        }

        .opt-btn.active {
            background: var(--green);
            color: white;
            border-color: var(--green);
        }

        .btn-request {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }

        .driver-info-card {
            position: fixed;
            bottom: 20px;
            left: 5%;
            width: 90%;
            background: white;
            z-index: 1100;
            border-radius: 25px;
            padding: 20px;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-top: 6px solid var(--green);
        }

        .sos-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--red);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            z-index: 3000;
            border: none;
            font-weight: bold;
            display: none;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(231, 76, 60, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }

        .rider-label {
            background: #000;
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
            border: none;
        }

        .searching-radar {
            width: 40px;
            height: 40px;
            border: 3px solid var(--accent);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .arrival-alert {
            position: fixed;
            top: 10%;
            left: 5%;
            width: 90%;
            background: var(--green);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            z-index: 3000;
            display: none;
        }
    </style>
</head>

<body>

    <button id="sos-btn" class="sos-btn" onclick="triggerSOS()">SOS</button>

    <div id="auth-screen">
        <h1>Ù…Ø´ÙˆØ§Ø±ÙŠ</h1>
        <p style="color: gray; margin-bottom: 20px;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø£Ø°ÙƒÙ‰ ÙˆØ³ÙŠÙ„Ø© ØªÙ†Ù‚Ù„</p>
        <button class="google-btn" id="login-btn">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg"> Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬ÙˆØ¬Ù„
        </button>
    </div>

    <div id="map"></div>

    <div class="bottom-card" id="control-panel" style="display:none;">
        <div id="location-status" style="font-weight: bold; margin-bottom: 10px; font-size: 14px; color: var(--green);">
            ğŸ“ Ø­Ø¯Ø¯ Ù…Ø³Ø§Ø± Ø±Ø­Ù„ØªÙƒ</div>
        <div class="search-container">
            <input type="text" id="pickup-input" class="search-box" style="border-right: 5px solid var(--green);"
                placeholder="Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø¡">
            <ul id="pickup-list" class="suggestions"></ul>
        </div>
        <div class="search-container">
            <input type="text" id="dest-input" class="search-box" style="border-right: 5px solid var(--red);"
                placeholder="Ø¥Ù„Ù‰ Ø£ÙŠÙ† Ù†Ø°Ù‡Ø¨ØŸ">
            <ul id="dest-list" class="suggestions"></ul>
        </div>
        <div class="options-grid">
            <button id="ac-opt" class="opt-btn" onclick="this.classList.toggle('active')">â„ï¸ ØªÙƒÙŠÙŠÙ</button>
            <button id="lady-opt" class="opt-btn" onclick="this.classList.toggle('active')">ğŸ‘© ÙƒØ§Ø¨ØªÙ† Ø³ÙŠØ¯Ø©</button>
        </div>
        <div id="price-estimation"
            style="font-weight:bold; background: #f1f3f5; padding: 10px; border-radius: 12px; margin-bottom: 10px; font-size: 14px;">
            Ø­Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ù‡Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø±...</div>
        <div style="margin-bottom:12px; font-size:13px; font-weight: bold;">
            Ø§Ù‚ØªØ±Ø§Ø­ Ø³Ø¹Ø±: <input type="number" id="manual-fare"
                style="width:70px; padding:6px; border-radius:8px; border:1px solid #ccc; text-align:center;"> Ø¬.Ù…
        </div>
        <button class="btn-request" id="main-btn">ØªØ£ÙƒÙŠØ¯ ÙˆØ·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø¢Ù†</button>
        <button id="cancel-search-btn" onclick="cancelRideRider()"
            style="background:none; border:none; color:gray; text-decoration:underline; cursor:pointer; margin-top:10px; font-family:'Cairo'; display:none;">Ø¥Ù„ØºØ§Ø¡
            Ø§Ù„Ø·Ù„Ø¨</button>
    </div>

    <div id="driver-card" class="driver-info-card">
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 id="d-name" style="margin:0; font-size: 18px;"></h3>
                <span id="d-car" style="font-size:13px; color:gray;"></span>
            </div>
            <div id="d-plate" style="font-weight:bold; border:2px solid black; padding:5px; border-radius:5px;"></div>
        </div>
        <div id="wait-timer" style="margin-top: 10px; font-weight: bold; color: var(--red); font-size: 14px;"></div>
        <a href="#" id="d-phone" class="btn-request"
            style="text-decoration:none; display:block; background:var(--green); text-align:center; margin-top:15px;">ğŸ“
            Ø§ØªØµÙ„ Ø¨Ø§Ù„ÙƒØ§Ø¨ØªÙ†</a>
        <button onclick="submitComplaint()"
            style="color:#888; background:none; border:none; text-decoration:underline; cursor:pointer; margin-top:15px; width:100%; font-size: 12px;">ØªÙ‚Ø¯ÙŠÙ…
            Ø´ÙƒÙˆÙ‰</button>
        <button onclick="cancelRideRider()"
            style="color:var(--red); background:none; border:none; text-decoration:underline; cursor:pointer; margin-top:10px; width:100%; font-size: 13px; font-weight:bold;">Ø¥Ù„ØºØ§Ø¡
            Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD8R4p1WaBn6s4yQxWpZzUkfznphYUOqqs",
            authDomain: "web-app-fb3f8.firebaseapp.com",
            projectId: "web-app-fb3f8",
            storageBucket: "web-app-fb3f8.firebasestorage.app",
            messagingSenderId: "1067792665032",
            appId: "1:1067792665032:web:015d23d10e359490c2d8fd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let map, pickupMarker, destinationMarker, driverMarker, routeLine, passengerTimer;
        let pickupLoc = null, destinationLoc = null, estimatedFare = 0, currentRideId = null;

        // 1. Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø²Ø±
        document.getElementById('login-btn').addEventListener('click', () => signInWithPopup(auth, provider));

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('control-panel').style.display = 'block';
                checkPersistence();
                initMap();
            }
        });

        async function checkPersistence() {
            const savedRideId = localStorage.getItem('activeRideId');
            if (savedRideId) {
                const snap = await getDoc(doc(db, "rides", savedRideId));
                if (snap.exists() && !['completed', 'cancelled_driver'].includes(snap.data().status)) {
                    currentRideId = savedRideId;
                    listenToRideStatus(currentRideId);
                    document.getElementById('control-panel').style.display = 'none';
                    document.getElementById('sos-btn').style.display = 'block';
                }
            }
        }

        function initMap() {
            if (map) return;
            map = L.map('map', { zoomControl: false }).setView([30.04, 31.23], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            map.locate({ setView: true, maxZoom: 17, enableHighAccuracy: true });

            map.on('locationfound', (e) => {
                document.getElementById('location-status').innerText = "ğŸ“ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ";
                if (!pickupLoc) setPickup(e.latlng.lat, e.latlng.lng);
            });
            map.on('click', (e) => { if (!pickupLoc) setPickup(e.latlng.lat, e.latlng.lng); else setDestination(e.latlng.lat, e.latlng.lng); });
        }

        async function getSuggestions(query, listId, inputId, type) {
            if (query.length < 3) { document.getElementById(listId).style.display = 'none'; return; }
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=eg&limit=5&accept-language=ar`);
            const data = await res.json();
            const list = document.getElementById(listId);
            list.innerHTML = "";
            if (data.length > 0) {
                list.style.display = 'block';
                data.forEach(item => {
                    const li = document.createElement('li');
                    li.innerText = item.display_name;
                    li.onclick = () => {
                        const lat = parseFloat(item.lat), lon = parseFloat(item.lon);
                        document.getElementById(inputId).value = item.display_name;
                        list.style.display = 'none';
                        if (type === 'pickup') setPickup(lat, lon); else setDestination(lat, lon);
                        map.flyTo([lat, lon], 17);
                    };
                    list.appendChild(li);
                });
            }
        }

        document.getElementById('pickup-input').addEventListener('input', (e) => getSuggestions(e.target.value, 'pickup-list', 'pickup-input', 'pickup'));
        document.getElementById('dest-input').addEventListener('input', (e) => getSuggestions(e.target.value, 'dest-list', 'dest-input', 'dest'));

        async function setPickup(lat, lng) {
            pickupLoc = { lat, lng };
            if (pickupMarker) map.removeLayer(pickupMarker);
            pickupMarker = L.marker([lat, lng], { draggable: true, icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', iconSize: [25, 41] }) }).addTo(map);
            pickupMarker.bindTooltip(auth.currentUser.displayName, { permanent: true, direction: 'top', className: 'rider-label' }).openTooltip();
            document.getElementById('pickup-input').value = await reverseGeocode(lat, lng);
            pickupMarker.on('dragend', async (e) => { pickupLoc = e.target.getLatLng(); document.getElementById('pickup-input').value = await reverseGeocode(pickupLoc.lat, pickupLoc.lng); calculateFare(); });
            calculateFare();
        }

        async function setDestination(lat, lng) {
            destinationLoc = { lat, lng };
            if (destinationMarker) map.removeLayer(destinationMarker);
            destinationMarker = L.marker([lat, lng], { draggable: true, icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [25, 41] }) }).addTo(map);
            document.getElementById('dest-input').value = await reverseGeocode(lat, lng);
            destinationMarker.on('dragend', async (e) => { destinationLoc = e.target.getLatLng(); document.getElementById('dest-input').value = await reverseGeocode(destinationLoc.lat, destinationLoc.lng); calculateFare(); });
            calculateFare();
        }

        async function reverseGeocode(lat, lng) {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ar`);
            const data = await res.json();
            return data.address.road || data.address.suburb || data.address.city || "Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¯Ø¯";
        }

        async function calculateFare() {
            if (!pickupLoc || !destinationLoc) return;
            const url = `https://router.project-osrm.org/route/v1/driving/${pickupLoc.lng},${pickupLoc.lat};${destinationLoc.lng},${destinationLoc.lat}?overview=full&geometries=geojson`;
            const res = await fetch(url);
            const data = await res.json();
            if (data.routes[0]) {
                const dist = data.routes[0].distance / 1000;
                if (routeLine) map.removeLayer(routeLine);
                const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                routeLine = L.polyline(coords, { color: '#3498db', weight: 5, opacity: 0.7 }).addTo(map);

                const pData = await (await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pickupLoc.lat}&lon=${pickupLoc.lng}`)).json();
                const dData = await (await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${destinationLoc.lat}&lon=${destinationLoc.lng}`)).json();
                let multiplier = (pData.address.state !== dData.address.state) ? 2 : 1;

                estimatedFare = Math.ceil((10 + (dist * 4.5) + 5) * multiplier);
                document.getElementById('price-estimation').innerHTML = `<span style="color:${multiplier > 1 ? 'var(--red)' : 'var(--green)'}">${multiplier > 1 ? 'âš ï¸ Ù…Ø´ÙˆØ§Ø± Ø®Ø§Ø±Ø¬ÙŠ (Ø°Ù‡Ø§Ø¨ ÙˆØ¥ÙŠØ§Ø¨)' : 'Ø£Ø¬Ø±Ø© Ø¯Ø§Ø®Ù„ÙŠØ©'}</span><br>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${dist.toFixed(1)} ÙƒÙ… | Ø§Ù„Ø£Ø¬Ø±Ø©: ${estimatedFare} Ø¬.Ù…`;
            }
        }

        document.getElementById('main-btn').addEventListener('click', async () => {
            if (!pickupLoc || !destinationLoc) return alert("Ø­Ø¯Ø¯ ÙˆØ¬Ù‡ØªÙƒ Ø£ÙˆÙ„Ø§Ù‹");
            const finalFare = document.getElementById('manual-fare').value || estimatedFare;
            currentRideId = "ride_" + auth.currentUser.uid;
            await setDoc(doc(db, "rides", currentRideId), {
                riderName: auth.currentUser.displayName, riderId: auth.currentUser.uid,
                pickup: pickupLoc, destination: destinationLoc, fare: finalFare,
                status: "searching", time: Date.now(),
                options: { ac: document.getElementById('ac-opt').classList.contains('active'), lady: document.getElementById('lady-opt').classList.contains('active') }
            });
            localStorage.setItem('activeRideId', currentRideId);
            listenToRideStatus(currentRideId);
        });
        window.cancelRideRider = async () => {
            if (!currentRideId) return;

            const reason = prompt("Ù„Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©ØŸ (Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ø¨Ø¨ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©)");

            if (reason) {
                try {
                    await updateDoc(doc(db, "rides", currentRideId), {
                        status: "cancelled_rider",
                        cancelReason: reason,
                        cancelledAt: Date.now()
                    });

                    // Ù…Ø³Ø­ Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©
                    localStorage.removeItem('activeRideId');
                    alert("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­.");
                    location.reload();
                } catch (e) {
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                }
            }
        };

        // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ£ÙƒÙŠØ¯ ÙˆØ·Ù„Ø¨"
        document.getElementById('main-btn').addEventListener('click', () => {
            document.getElementById('cancel-search-btn').style.display = 'inline-block';
        });

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø²Ø§ÙŠØ¯Ø© Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ø§Ù„Ù†Ø§ÙØ°Ø©
        window.acceptCounter = async (price) => { await updateDoc(doc(db, "rides", currentRideId), { status: "accepted", fare: price }); };
        window.rejectCounter = async () => { await updateDoc(doc(db, "rides", currentRideId), { status: "rejected", driver_price: null }); };

        function listenToRideStatus(rideId) {
            onSnapshot(doc(db, "rides", rideId), (snapshot) => {
                const data = snapshot.data();
                if (!data) return;

                // 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø§ÙˆÙ…Ø©
                if (data.status === "driver_offered") {
                    document.getElementById('location-status').innerHTML = `
                        <div style="background:#fff3cd; padding:12px; border-radius:15px; border:1px solid #ffeeba; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                            <b>Ø§Ù„ÙƒØ§Ø¨ØªÙ† ${data.driverName} ÙŠØ·Ù„Ø¨: ${data.driver_price} Ø¬.Ù…</b><br>
                            <button onclick="acceptCounter('${data.driver_price}')" style="background:#27ae60; color:white; border:none; padding:8px 15px; border-radius:8px; margin:5px; cursor:pointer;">Ù‚Ø¨ÙˆÙ„</button>
                            <button onclick="rejectCounter()" style="background:#e74c3c; color:white; border:none; padding:8px 15px; border-radius:8px; margin:5px; cursor:pointer;">Ø±ÙØ¶</button>
                        </div>`;
                }

                if (data.status === "searching") {
                    document.getElementById('location-status').innerHTML = `<div class="searching-radar"></div><b>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒØ§Ø¨ØªÙ†...</b>`;
                }

                if (data.status === "accepted" || data.status === "arrived") {
                    document.getElementById('control-panel').style.display = 'none';
                    document.getElementById('driver-card').style.display = 'block';
                    document.getElementById('sos-btn').style.display = 'block';

                    // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ø¨ØªÙ† ÙˆØ§Ù„Ø³ÙŠØ§Ø±Ø©
                    document.getElementById('d-name').innerText = "ÙƒØ§Ø¨ØªÙ†: " + (data.driverName || "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„");
                    document.getElementById('d-car').innerText = (data.carColor || "") + " " + (data.carModel || "");
                    document.getElementById('d-plate').innerText = data.carPlate || "----";
                    document.getElementById('d-phone').href = "tel:" + data.driverPhone;

                    if (data.status === "arrived") startPassengerTimer(data.arrivalTime);

                    if (data.driverLocation) {
                        const dPos = [data.driverLocation.lat, data.driverLocation.lng];
                        if (!driverMarker) driverMarker = L.marker(dPos, { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/235/235889.png', iconSize: [40, 40] }) }).addTo(map);
                        else driverMarker.setLatLng(dPos);
                        map.fitBounds([dPos, [pickupLoc.lat, pickupLoc.lng]], { padding: [80, 80], animate: true });
                    }
                }
                if (data.status === "completed") { alert("Ø±Ø­Ù„Ø© Ø³Ø¹ÙŠØ¯Ø©!"); localStorage.removeItem('activeRideId'); location.reload(); }
                if (data.status === "cancelled_driver") { alert("Ø£Ù„ØºÙ‰ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø±Ø­Ù„Ø© Ù„Ø³Ø¨Ø¨: " + data.cancelReason); localStorage.removeItem('activeRideId'); location.reload(); }
            });
        }

        function startPassengerTimer(arrivalTime) {
            if (passengerTimer) return;
            passengerTimer = setInterval(() => {
                const timeLeft = 60 - Math.floor((Date.now() - arrivalTime) / 1000);
                if (timeLeft > 0) document.getElementById('wait-timer').innerText = `âš ï¸ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬! Ù…ØªØ¨Ù‚ÙŠ: ${timeLeft} Ø«Ø§Ù†ÙŠØ©`;
                else { clearInterval(passengerTimer); document.getElementById('wait-timer').innerText = "Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±!"; }
            }, 1000);
        }

        window.triggerSOS = async () => {
            if (confirm("ğŸš¨ Ù‡Ù„ Ø£Ù†Øª ÙÙŠ Ø®Ø·Ø±ØŸ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹Ùƒ ÙÙˆØ±Ø§Ù‹ Ù„ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª!")) {
                await updateDoc(doc(db, "rides", currentRideId), {
                    sos_active: true, // Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯
                    sos_by: "rider",
                    sos_time: Date.now()
                });
                alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³ØªØºØ§Ø«Ø©! Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ØªØªØ§Ø¨Ø¹Ùƒ Ø§Ù„Ø¢Ù†.");
            }
        };
        window.submitComplaint = async () => { const reason = prompt("Ù…Ø§ Ù‡ÙŠ Ø´ÙƒÙˆØ§ÙƒØŸ"); if (reason) await setDoc(doc(db, "complaints", "c_" + Date.now()), { rideId: currentRideId, reason: reason, time: Date.now() }); };

    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø´ÙˆØ§Ø±ÙŠ - Ø§Ø·Ù„Ø¨ Ø±Ø­Ù„ØªÙƒ</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #000000;
            --accent: #3498db;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Cairo', sans-serif;
            background: #eee;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            z-index: 1;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #auth-screen {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .google-btn {
            background: #fff;
            color: #757575;
            border: 1px solid #ddd;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            font-weight: bold;
        }

        .google-btn img {
            width: 22px;
            height: 22px;
            margin-left: 10px;
        }

        /* Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙÙ„Ù‰ */
        .bottom-card {
            position: fixed;
            bottom: 20px;
            left: 5%;
            width: 90%;
            background: white;
            z-index: 1000;
            border-radius: 15px;
            padding: 20px;
            box-sizing: border-box;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            font-family: 'Cairo';
            font-size: 14px;
            box-sizing: border-box;
        }

        .btn-request {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ */
        .driver-info-card {
            position: fixed;
            bottom: 20px;
            left: 5%;
            width: 90%;
            background: white;
            z-index: 1100;
            border-radius: 20px;
            padding: 15px;
            display: none;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            border-top: 5px solid #27ae60;
        }

        .car-badge {
            background: #eee;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }

        .call-btn {
            background: #27ae60;
            color: white;
            text-decoration: none;
            padding: 10px;
            border-radius: 10px;
            display: block;
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div id="auth-screen">
        <h1>Ù…Ø´ÙˆØ§Ø±ÙŠ</h1>
        <p>Ø£Ø³Ø±Ø¹ ÙˆØ³ÙŠÙ„Ø© Ù„Ù„ØªÙ†Ù‚Ù„ ÙÙŠ Ù…ØµØ±</p>
        <button class="google-btn" onclick="loginWithGoogle()">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg">
            Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬ÙˆØ¬Ù„
        </button>
    </div>

    <div id="map"></div>

    <div class="bottom-card" id="control-panel" style="display:none;">
        <div id="location-status" style="font-weight: bold; margin-bottom: 10px;">ğŸ“ Ø­Ø¯Ø¯ ØªÙØ§ØµÙŠÙ„ Ø±Ø­Ù„ØªÙƒ</div>

        <div style="display: flex; gap: 5px; margin-bottom: 8px;">
            <input type="text" id="pickup-input" class="search-box"
                style="margin-bottom:0; border-right: 4px solid #27ae60;" placeholder="Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø¡ (Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...)">
            <button onclick="searchPlace('pickup')"
                style="background: #27ae60; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">ğŸ”</button>
        </div>

        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <input type="text" id="dest-input" class="search-box"
                style="margin-bottom:0; border-right: 4px solid #e74c3c;" placeholder="Ø¥Ù„Ù‰ Ø£ÙŠÙ† ØªØ±ÙŠØ¯ Ø§Ù„Ø°Ù‡Ø§Ø¨ØŸ">
            <button onclick="searchPlace('dest')"
                style="background: #e74c3c; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">ğŸ”</button>
        </div>

        <div id="price-estimation"
            style="font-weight:bold; color:#2c3e50; background: #f9f9f9; padding: 8px; border-radius: 8px; margin-bottom: 10px;">
            Ø­Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø·ØªÙŠÙ† Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø±...</div>
        <button class="btn-request" id="main-btn" onclick="requestRide()">ØªØ£ÙƒÙŠØ¯ ÙˆØ·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø¢Ù†</button>
    </div>

    <div id="driver-card" class="driver-info-card">
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 id="d-name" style="margin:0">Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ†</h3>
                <span id="d-car" class="car-badge">Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</span>
            </div>
            <div id="d-plate" style="font-weight:bold; border:2px solid black; padding:5px;">Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</div>
        </div>
        <a href="#" id="d-phone" class="call-btn">ğŸ“ Ø§ØªØµÙ„ Ø¨Ø§Ù„ÙƒØ§Ø¨ØªÙ†</a>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD8R4p1WaBn6s4yQxWpZzUkfznphYUOqqs",
            authDomain: "web-app-fb3f8.firebaseapp.com",
            projectId: "web-app-fb3f8",
            storageBucket: "web-app-fb3f8.firebasestorage.app",
            messagingSenderId: "1067792665032",
            appId: "1:1067792665032:web:015d23d10e359490c2d8fd",
            measurementId: "G-7KFBEHHB7W"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let map, pickupMarker, destinationMarker, driverMarker;
        let pickupLoc = null, destinationLoc = null;
        let estimatedFare = 0;

        window.loginWithGoogle = async () => {
            try { await signInWithPopup(auth, provider); }
            catch (e) { alert("ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Google Sign-in ÙÙŠ Firebase Console"); }
        };

        // ÙˆØ¸ÙŠÙØ© Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ù…Ù† Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
        async function getAddressFromCoords(lat, lng, inputId) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ar`);
                const data = await res.json();
                if (data.display_name) {
                    const address = data.address.road || data.address.suburb || data.address.city || "Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¯Ø¯";
                    document.getElementById(inputId).value = address;
                }
            } catch (e) { console.log("Error fetching address"); }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('control-panel').style.display = 'block';
                initMap();
            }
        });

        function initMap() {
            if (map) return;
            map = L.map('map', { zoomControl: false }).setView([30.0444, 31.2357], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            map.locate({ setView: true, maxZoom: 16 });

            map.on('locationfound', (e) => {
                if (!pickupLoc) updatePickup(e.latlng.lat, e.latlng.lng);
            });
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø¡ (Ù…Ø¹ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
        function updatePickup(lat, lng) {
            pickupLoc = { lat, lng };
            if (pickupMarker) map.removeLayer(pickupMarker);
            pickupMarker = L.marker([lat, lng], {
                draggable: true,
                icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', iconSize: [25, 41], iconAnchor: [12, 41] })
            }).addTo(map).bindPopup("Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø¡").openPopup();

            getAddressFromCoords(lat, lng, 'pickup-input');

            pickupMarker.on('dragend', (e) => {
                const pos = e.target.getLatLng();
                pickupLoc = { lat: pos.lat, lng: pos.lng };
                getAddressFromCoords(pos.lat, pos.lng, 'pickup-input');
                calculateFinalFare();
            });
            calculateFinalFare();
        }

        window.searchPlace = async (type) => {
            const query = document.getElementById(type === 'pickup' ? 'pickup-input' : 'dest-input').value;
            if (query.length < 3) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ø¨ÙˆØ¶ÙˆØ­");

            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
            const data = await res.json();

            if (data.length > 0) {
                const lat = parseFloat(data[0].lat), lon = parseFloat(data[0].lon);
                if (type === 'pickup') {
                    updatePickup(lat, lon);
                } else {
                    destinationLoc = { lat, lng: lon };
                    if (destinationMarker) map.removeLayer(destinationMarker);
                    destinationMarker = L.marker([lat, lon], {
                        draggable: true,
                        icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [25, 41], iconAnchor: [12, 41] })
                    }).addTo(map).bindPopup("ÙˆØ¬Ù‡Ø© Ø§Ù„ÙˆØµÙˆÙ„").openPopup();

                    destinationMarker.on('dragend', (e) => {
                        destinationLoc = { lat: e.target.getLatLng().lat, lng: e.target.getLatLng().lng };
                        calculateFinalFare();
                    });
                }
                if (pickupLoc && destinationLoc) map.fitBounds([[pickupLoc.lat, pickupLoc.lng], [destinationLoc.lat, destinationLoc.lng]], { padding: [50, 50] });
                else map.flyTo([lat, lon], 15);
                calculateFinalFare();
            } else { alert("Ù„Ù… Ù†Ø¬Ø¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"); }
        };

        // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø°ÙƒÙŠØ© (Ù…Ø¹ Ø¹Ù…ÙˆÙ„ØªÙƒ)
        async function calculateFinalFare() {
            if (!pickupLoc || !destinationLoc) return;
            const url = `https://router.project-osrm.org/route/v1/driving/${pickupLoc.lng},pickupLoc.lat;${destinationLoc.lng},${destinationLoc.lat}?overview=false`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.routes && data.routes[0]) {
                    const distanceKM = data.routes[0].distance / 1000;

                    // Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©: 10 (ÙØªØ­ Ø¹Ø¯Ø§Ø¯) + (Ø§Ù„Ù…Ø³Ø§ÙØ© * 4.5 Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„Ùˆ) + 5 (Ø¹Ù…ÙˆÙ„ØªÙƒ)
                    estimatedFare = Math.ceil(10 + (distanceKM * 4.5) + 5);

                    document.getElementById('price-estimation').innerHTML = `
                        <div style="font-size:12px; color:gray;">Ø£Ø±Ø®Øµ Ù…Ù† Ø£ÙˆØ¨Ø± ÙˆØ¯ÙŠØ¯ÙŠ</div>
                        <b>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${distanceKM.toFixed(1)} ÙƒÙ… | Ø§Ù„Ø£Ø¬Ø±Ø©: ${estimatedFare} Ø¬.Ù…</b>
                    `;
                }
            } catch (e) { console.log("Fare error"); }
        }

        window.requestRide = async () => {
            if (!pickupLoc || !destinationLoc) return alert("Ø­Ø¯Ø¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø¡ ÙˆØ§Ù„ÙˆØ¬Ù‡Ø© Ø£ÙˆÙ„Ø§Ù‹");
            const btn = document.getElementById('main-btn');
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒØ§Ø¨ØªÙ†...";
            btn.disabled = true;

            const rideId = "ride_" + auth.currentUser.uid;
            await setDoc(doc(db, "rides", rideId), {
                riderName: auth.currentUser.displayName,
                pickup: pickupLoc,
                destination: destinationLoc,
                fare: estimatedFare,
                status: "searching",
                time: new Date()
            });
            listenToRideStatus(rideId);
        };

        function listenToRideStatus(rideId) {
            onSnapshot(doc(db, "rides", rideId), (snapshot) => {
                const data = snapshot.data();
                if (data && data.status === "accepted") {
                    document.getElementById('control-panel').style.display = 'none';
                    document.getElementById('driver-card').style.display = 'block';
                    document.getElementById('d-name').innerText = data.driverName;
                    document.getElementById('d-car').innerText = `${data.carColor} - ${data.carModel}`;
                    document.getElementById('d-plate').innerText = data.carPlate;
                    document.getElementById('d-phone').href = "tel:" + data.driverPhone;

                    if (data.driverLocation) {
                        const pos = [data.driverLocation.lat, data.driverLocation.lng];
                        if (!driverMarker) {
                            driverMarker = L.marker(pos, { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/235/235889.png', iconSize: [35, 35] }) }).addTo(map);
                        } else { driverMarker.setLatLng(pos); }
                    }
                }
            });
        }

        document.getElementById('pickup-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') searchPlace('pickup'); });
        document.getElementById('dest-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') searchPlace('dest'); });
    </script>
</body>

</html>
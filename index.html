<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø´ÙˆØ§Ø±ÙŠ - Ø§Ø·Ù„Ø¨ Ø±Ø­Ù„ØªÙƒ</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #000000;
            --accent: #3498db;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Cairo', sans-serif;
            background: #eee;
        }

        /* ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØªØ£Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø­Ø© ÙƒØ§Ù…Ù„Ø© */
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            z-index: 1;
        }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Ø¬ÙˆØ¬Ù„ */
        #auth-screen {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .google-btn {
            background: #fff;
            color: #757575;
            border: 1px solid #ddd;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 18px;
            display: flex;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .google-btn img {
            width: 25px;
            margin-left: 10px;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-card {
            position: fixed;
            bottom: 20px;
            left: 5%;
            width: 90%;
            background: white;
            z-index: 1000;
            border-radius: 15px;
            padding: 20px;
            box-sizing: border-box;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .btn-request {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
        }

        #location-status {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .driver-info-card {
            position: fixed;
            bottom: 20px;
            left: 5%;
            width: 90%;
            background: white;
            z-index: 1100;
            border-radius: 20px;
            padding: 15px;
            display: none;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            border-top: 5px solid #27ae60;
        }

        .car-badge {
            background: #eee;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }

        .call-btn {
            background: #27ae60;
            color: white;
            text-decoration: none;
            padding: 10px;
            border-radius: 10px;
            display: block;
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="auth-screen">
        <h1 style="color: black;">Ù…Ø´ÙˆØ§Ø±ÙŠ</h1>
        <p>Ø£Ø³Ø±Ø¹ ÙˆØ³ÙŠÙ„Ø© Ù„Ù„ØªÙ†Ù‚Ù„</p>
        <button class="google-btn" onclick="loginWithGoogle()">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg">
            Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬ÙˆØ¬Ù„
        </button>
    </div>

    <div id="map"></div>

    <div class="bottom-card" id="control-panel" style="display:none;">
        <div id="location-status">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø±ÙƒÙˆØ¨</div>
        <button class="btn-request" id="main-btn" onclick="requestRide()">ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    </div>
    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø§ÙƒØ¨ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© -->
    <div id="control-panel" class="bottom-card" style="display:none;">
        <input type="text" id="dest-input" class="search-box" style="margin-bottom:10px"
            placeholder="Ø¥Ù„Ù‰ Ø£ÙŠÙ† ØªØ±ÙŠØ¯ Ø§Ù„Ø°Ù‡Ø§Ø¨ØŸ">
        <div id="price-estimation" style="font-weight:bold; color:#27ae60; margin:10px 0;"></div>
        <button class="btn-request" id="main-btn" onclick="requestRide()">Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† Ø¨Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ÙˆØ¶Ø­</button>
    </div>

    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„ -->
    <div id="driver-card" class="driver-info-card">
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 id="d-name" style="margin:0">Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ†</h3>
                <span id="d-car" class="car-badge">Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</span>
            </div>
            <div id="d-plate" style="font-weight:bold; border:2px solid black; padding:5px;">Ø£ Ø¨ Ø¬ 123</div>
        </div>
        <a href="#" id="d-phone" class="call-btn">ğŸ“ Ø§ØªØµÙ„ Ø¨Ø§Ù„ÙƒØ§Ø¨ØªÙ†</a>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            // Ø¶Ø¹ Ù‡Ù†Ø§ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù…Ù† Firebase
            apiKey: "AIzaSyD8R4p1WaBn6s4yQxWpZzUkfznphYUOqqs",
            authDomain: "web-app-fb3f8.firebaseapp.com",
            projectId: "web-app-fb3f8",
            storageBucket: "web-app-fb3f8.firebasestorage.app",
            messagingSenderId: "1067792665032",
            appId: "1:1067792665032:web:015d23d10e359490c2d8fd",
            measurementId: "G-7KFBEHHB7W"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let map, userMarker;
        let selectedLocation = null;
        let destinationLoc = null;
        let estimatedFare = 0;

        // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„
        window.loginWithGoogle = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„: ", error);
                alert("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
            }
        };

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('control-panel').style.display = 'block';
                initMap();
            }
        });

        function initMap() {
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ø§ ØªØ¹Ø¯ ØªØ­Ù…ÙŠÙ„Ù‡Ø§
            if (map) return;

            // Ø¨Ø¯Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            map = L.map('map', { zoomControl: false }).setView([30.0444, 31.2357], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
            map.locate({ setView: true, maxZoom: 16 });

            // Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹
            map.on('click', function (e) {
                setPickupLocation(e.latlng.lat, e.latlng.lng);
            });

            map.on('locationfound', function (e) {
                setPickupLocation(e.latlng.lat, e.latlng.lng);
            });
        }

        function setPickupLocation(lat, lng) {
            selectedLocation = { lat, lng };
            if (userMarker) map.removeLayer(userMarker);

            userMarker = L.marker([lat, lng], { draggable: true }).addTo(map);
            document.getElementById('location-status').innerText = "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: " + lat.toFixed(4) + ", " + lng.toFixed(4);

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¥Ø°Ø§ Ù‚Ø§Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
            userMarker.on('dragend', function (event) {
                let marker = event.target;
                let position = marker.getLatLng();
                selectedLocation = { lat: position.lat, lng: position.lng };
            });
        }

        window.requestRide = async () => {
            if (!selectedLocation) {
                alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }

            const rideId = "ride_" + auth.currentUser.uid;
            const btn = document.getElementById('main-btn');
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒØ§Ø¨ØªÙ†...";
            btn.disabled = true;

            try {
                await setDoc(doc(db, "rides", rideId), {
                    riderName: auth.currentUser.displayName,
                    riderId: auth.currentUser.uid,
                    pickup: selectedLocation,
                    status: "searching",
                    time: new Date()
                });
                listenToRideStatus(rideId);
            } catch (e) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨");
                btn.disabled = false;
            }
        };

        function listenToRideStatus(rideId) {
            onSnapshot(doc(db, "rides", rideId), (doc) => {
                const data = doc.data();
                if (data.status === "accepted") {
                    document.getElementById('location-status').innerText = "ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ! Ø§Ù„Ø³Ø§Ø¦Ù‚: " + data.driverName;
                    document.getElementById('main-btn').style.background = "#27ae60";
                    document.getElementById('main-btn').innerText = "Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚";
                }
            });
        }
        // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø³Ø¹Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OSRM
        async function calculateFare(start, end) {
            const url = `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=false`;
            const response = await fetch(url);
            const data = await response.json();
            const distanceKM = data.routes[0].distance / 1000;

            // Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ±: 10 Ø¬Ù†ÙŠÙ‡ ÙØªØ­ Ø¹Ø¯Ø§Ø¯ + 5 Ø¬Ù†ÙŠÙ‡ Ù„ÙƒÙ„ ÙƒÙŠÙ„Ùˆ
            estimatedFare = Math.ceil(10 + (distanceKM * 5));
            document.getElementById('price-estimation').innerText = `Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚Ø¯Ø±: ${estimatedFare} Ø¬.Ù…`;
        }

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø© ÙˆØªØªØ¨Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
        function listenToRideStatus(rideId) {
            let driverMarker;
            onSnapshot(doc(db, "rides", rideId), (snapshot) => {
                const data = snapshot.data();
                if (data.status === "accepted") {
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚
                    document.getElementById('control-panel').style.display = 'none';
                    document.getElementById('driver-card').style.display = 'block';
                    document.getElementById('d-name').innerText = data.driverName;
                    document.getElementById('d-car').innerText = `${data.carColor} - ${data.carModel}`;
                    document.getElementById('d-plate').innerText = data.carPlate;
                    document.getElementById('d-phone').href = "tel:" + data.driverPhone;

                    // Ø±Ø³Ù… Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                    if (data.driverLocation) {
                        const pos = [data.driverLocation.lat, data.driverLocation.lng];
                        if (!driverMarker) {
                            const carIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/235/235889.png', iconSize: [35, 35] });
                            driverMarker = L.marker(pos, { icon: carIcon }).addTo(map);
                        } else {
                            driverMarker.setLatLng(pos);
                        }
                        // ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„ØªØ´Ù…Ù„ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„Ø±Ø§ÙƒØ¨
                        map.fitBounds([pos, [data.pickup.lat, data.pickup.lng]], { padding: [50, 50] });
                    }
                }
            });
        }
    </script>
</body>

</html>